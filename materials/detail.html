<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/bootstrap.min.css" crossorigin="anonymous">

    <title>材料列表详情 | Agatha纯净生存</title>
  </head>
  <body onload="Verify(); loadMaterialDetail();">
      <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
<div class="container-fluid">
<a class="navbar-brand" href="/accounts/">
<img src="/img/Ag_0404.png" alt="" width="30" height="30" class="d-inline-block align-text-top">
材料列表详情
</a>
</div>
</nav>

    <div class="container" style="margin-top:2rem" id="AuthenticatingForm">
    <div class="row">
      <div class="col-3 text-right">
      <div class="spinner-border text-primary" role="status">
  <span class="sr-only">Loading...</span>
</div>

    </div>
    <div class="col-9"><h2>正在加载</h2></div>
    </div>
</div>


<div class="container" style="margin-top:1rem;display:none" id="DetailContainer">
    <div class="d-flex justify-content-between align-items-center">
        <h2 id="material-name">材料详情</h2>
        <div>
            <button class="btn btn-primary" onclick="showEditModal()">编辑</button>
            <button id="doneButton" class="btn btn-success" onclick="markAsDone()">标记为完成</button>
            <button class="btn btn-danger" onclick="hideMaterial()">删除</button>
        </div>
    </div>
    <p id="material-description" class="mb-4"></p>
    
    <div class="mb-3">
        <strong>状态:</strong> <span id="material-status"></span>
    </div>
    
    <div class="mb-3">
        <strong>上传时间:</strong> <span id="upload-time"></span>
    </div>
    
    <div class="mb-3">
        <strong>完成时间:</strong> <span id="done-time">-</span>
    </div>
    
    <h4 class="mt-4">材料清单</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>名称</th>
                <th>数量</th>
                <th>状态</th>
            </tr>
        </thead>
        <tbody id="material-items">
            <!-- Material items will be loaded here -->
        </tbody>
    </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">编辑材料信息</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="mb-3">
            <label for="edit-name" class="form-label">名称</label>
            <input type="text" class="form-control" id="edit-name" required>
          </div>
          <div class="mb-3">
            <label for="edit-description" class="form-label">描述</label>
            <textarea class="form-control" id="edit-description" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
      </div>
    </div>
  </div>
</div>

<script src="/js/jquery.slim.min.js" crossorigin="anonymous"></script>
<script src="/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="/js/verify_materials.js"></script>
<script>
    let currentMaterialId;
    let materialData;

    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(window.location.href);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function loadMaterialDetail() {
        currentMaterialId = getUrlParameter('id');
        if (!currentMaterialId) {
            document.getElementById("AuthenticatingForm").innerHTML = 
                '<div class="alert alert-danger">无效的请求：缺少材料ID</div>';
            return;
        }

        var Session = Verify_getCookie("sess");
        fetch(`https://api-materials.agatha.org.cn/mod/detail?id=${currentMaterialId}`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                throw new Error(result.message);
            }
            
            const data = result.data;
            document.getElementById("AuthenticatingForm").style.display = "none";
            document.getElementById("DetailContainer").style.display = "block";
            
            materialData = data;
            
            // Display material information
            document.getElementById("material-name").textContent = data.name;
            document.getElementById("material-description").textContent = data.description;
            
            // Status display
            const statusElement = document.getElementById("material-status");
            if (data.done) {
                statusElement.textContent = "已完成";
                statusElement.className = "text-success";
                document.getElementById("doneButton").style.display = "none";
            } else {
                statusElement.textContent = "未完成";
                statusElement.className = "text-warning";
                document.getElementById("doneButton").style.display = "inline-block";
            }
            
            // Time displays
            document.getElementById("upload-time").textContent = new Date(data.upload_time * 1000).toLocaleString();
            document.getElementById("done-time").textContent = data.done_time ? new Date(data.done_time * 1000).toLocaleString() : "-";
            
            // Parse the JSON items
            let items = [];
            try {
                items = JSON.parse(data.json);
            } catch (e) {
                console.error('Error parsing JSON:', e);
            }
            
            // Display material items
            const itemsContainer = document.getElementById("material-items");
            let html = '';
            
            if (items && items.length > 0) {
                items.forEach((item, index) => {
                    const statusText = item.done ? "已完成" : "未完成";
                    const statusClass = item.done ? "text-success" : "text-warning";
                    const occupiedBy = item.occupied ? `由 ${item.occupied}` : "";
                    
                    html += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.count}</td>
                            <td>
                                <span class="${statusClass}">${statusText}</span>
                                ${occupiedBy ? `<br><small>${occupiedBy}</small>` : ''}
                            </td>
                        </tr>
                    `;
                });
            } else {
                html = '<tr><td colspan="3" class="text-center">暂无材料项</td></tr>';
            }
            
            itemsContainer.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading material detail:', error);
            document.getElementById("AuthenticatingForm").innerHTML = 
                '<div class="alert alert-danger">加载失败：' + error.message + '</div>';
        });
    }

    function showEditModal() {
        document.getElementById("edit-name").value = materialData.name;
        document.getElementById("edit-description").value = materialData.description;
        $('#editModal').modal('show');
    }

    function saveEdit() {
        const newName = document.getElementById("edit-name").value.trim();
        const newDescription = document.getElementById("edit-description").value.trim();
        
        if (!newName || !newDescription) {
            alert("名称和描述不能为空");
            return;
        }
        
        var Session = Verify_getCookie("sess");
        fetch('https://api-materials.agatha.org.cn/api/edit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `session=${Session}&id=${currentMaterialId}&name=${encodeURIComponent(newName)}&description=${encodeURIComponent(newDescription)}`
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert("编辑失败：" + result.message);
                return;
            }
            
            // Update displayed data
            materialData.name = newName;
            materialData.description = newDescription;
            document.getElementById("material-name").textContent = newName;
            document.getElementById("material-description").textContent = newDescription;
            
            // Close modal using jQuery (Bootstrap 5)
            $('#editModal').modal('hide');
            
            // Show success message
            alert("保存成功");
        })
        .catch(error => {
            console.error('Error saving edit:', error);
            alert("保存失败，请稍后重试");
        });
    }

    function markAsDone() {
        if (!confirm("确定要将此材料清单标记为完成吗？")) {
            return;
        }
        
        var Session = Verify_getCookie("sess");
        fetch('https://api-materials.agatha.org.cn/api/done', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `session=${Session}&id=${currentMaterialId}`
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert("标记失败：" + result.message);
                return;
            }
            
            // Update UI
            materialData.done = 1;
            const statusElement = document.getElementById("material-status");
            statusElement.textContent = "已完成";
            statusElement.className = "text-success";
            document.getElementById("doneButton").style.display = "none";
            
            // Update done time
            const currentTime = Math.floor(Date.now() / 1000);
            materialData.donetime = currentTime;
            document.getElementById("done-time").textContent = new Date(currentTime * 1000).toLocaleString();
        })
        .catch(error => {
            console.error('Error marking as done:', error);
            alert("操作失败，请稍后重试");
        });
    }

    function hideMaterial() {
        if (!confirm("确定要删除此材料清单吗？")) {
            return;
        }
        
        var Session = Verify_getCookie("sess");
        fetch('https://api-materials.agatha.org.cn/api/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `session=${Session}&id=${currentMaterialId}`
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert("删除失败：" + result.message);
                return;
            }
            
            alert("删除成功");
            window.location.href = '/materials/dash.html';
        })
        .catch(error => {
            console.error('Error hiding material:', error);
            alert("删除失败，请稍后重试");
        });
    }

    function markItemAsDone(index) {
        alert("此功能尚未实现");
    }
</script>

</body>
</html>