<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/bootstrap.min.css" crossorigin="anonymous">

    <title>OpenID免登入口 | Agatha纯净生存</title>
  </head>
  <body onload="Verify();">
      <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
<div class="container-fluid">
<a class="navbar-brand" href="/accounts/">
<img src="/img/Ag_0404.png" alt="" width="30" height="30" class="d-inline-block align-text-top">
OpenID免登入口
</a>
</div>
</nav>

    <div class="container" style="margin-top:2rem" id="AuthenticatingForm">
    <div class="row">
      <div class="col-3 text-right">
      <div class="spinner-border text-primary" role="status">
  <span class="sr-only">Loading...</span>
</div>

    </div>
    <div class="col-9"><h2>认证进行中</h2><p id="debug"></p></div>
    <div class="alert alert-danger alert-dismissible fade" role="alert" id="Alert_LoginFailed" style="margin-top:1rem">
        <strong>错误：</strong>登录失败
    </div>
    </div>
</div>



    <script src="/js/jquery.slim.min.js" crossorigin="anonymous"></script>
    <script src="/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <script>
        function Verify(){
            dd.runtime.permission.requestAuthCode({
                corpId: "ding8b5123bd5729ddacbc961a6cb783455b",
                onSuccess: async function(result) {
                    var code = result.code;
                    const formData = new FormData();
                    formData.append('code', code);
                    try {
                        const response = await fetch('https://api-openid.agatha.org.cn/account/loginViaDingtalk', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded' // 设置正确的 Content-Type
                            },
                            body: 'code=' + code
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const respond = await response.json();

                        if(respond.status=="ok"){
        					Login_SetCookie("sess",respond.session);
        					var redirect = "https://mc.agatha.org.cn/accounts/";
        					window.location.href = redirect;
        				}else if(respond.status=="pass_failed"){
        				    var redirect = "https://mc.agatha.org.cn/accounts/login.html";
        					window.location.href = redirect;
        				}
        				else{
        					document.getElementById("Alert_LoginFailed").className="alert alert-danger alert-dismissible fade show";
        					document.getElementById("Alert_LoginFailed").innerHTML="<strong>您的账号已被封禁：</strong>"+respond.reason;
        				}
                    } catch (error) {}
                },
                onFail : function(err) {}
             
            })
        }
        function Login_SetCookie(name,value){
		    var Days = 30;//此 cookie 将被保存 30 天
		    var exp = new Date();//new Date("December 31, 9998");
		    exp.setTime(exp.getTime() + Days*24*60*60*1000);
		    document.cookie = name + "="+ escape (value) + ";path=/;expires=" + exp.toGMTString();
	    }
    </script>
  </body>
</html>